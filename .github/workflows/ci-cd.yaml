name: EmailSuite Pipeline

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '18.x'
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # 1. Frontend Matrix Build
  frontends:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [chrome-extension, web-dashboard]
    defaults:
      run:
        working-directory: ./frontend/${{ matrix.component }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './frontend/${{ matrix.component }}/package-lock.json'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
      
      - name: Package Chrome Extension (Multi-browser)
        if: matrix.component == 'chrome-extension'
        run: |
          # Install packaging dependencies
          npm install --save-dev fs-extra adm-zip
          
          # Create packaging script
          cat > scripts/package-extension.js << 'EOF'
          import fs from 'fs-extra';
          import path from 'path';
          import { fileURLToPath } from 'url';
          import AdmZip from 'adm-zip';

          const __dirname = path.dirname(fileURLToPath(import.meta.url));

          async function packageExtension() {
            try {
              const distDir = path.join(__dirname, '../dist');
              const chromeManifest = path.join(__dirname, '../manifest.chrome.json');
              const firefoxManifest = path.join(__dirname, '../manifest.firefox.json');
              
              // Ensure dist exists
              if (!await fs.pathExists(distDir)) {
                throw new Error('Dist directory not found. Run build first!');
              }

              // Package for Chrome (MV3)
              console.log('ðŸ“¦ Packaging for Chrome...');
              const chromeZip = new AdmZip();
              chromeZip.addLocalFolder(distDir);
              
              if (await fs.pathExists(chromeManifest)) {
                chromeZip.addFile('manifest.json', await fs.readFile(chromeManifest));
              } else {
                // Fallback to default manifest for Chrome
                const defaultManifest = {
                  manifest_version: 3,
                  name: "Email Suite - Email Tracker for Gmail",
                  version: "1.0.0",
                  description: "Track email opens, clicks, and boost productivity",
                  permissions: ["storage", "activeTab", "scripting", "notifications"],
                  host_permissions: ["https://mail.google.com/*", "https://*.emailsuite.com/*"],
                  background: { service_worker: "dist/background.js", type: "module" },
                  content_scripts: [{
                    matches: ["https://mail.google.com/*"],
                    js: ["dist/content-scripts/gmail-injector.js"],
                    css: ["dist/styles/inject.css"]
                  }],
                  action: { default_popup: "dist/popup/index.html", default_title: "Email Suite" },
                  web_accessible_resources: [{
                    resources: ["dist/tracking-pixel.png"],
                    matches: ["https://mail.google.com/*"]
                  }]
                };
                chromeZip.addFile('manifest.json', Buffer.from(JSON.stringify(defaultManifest, null, 2)));
              }
              chromeZip.writeZip(path.join(__dirname, '../chrome-extension.zip'));
              console.log('âœ… Created chrome-extension.zip');

              // Package for Firefox (MV2)
              console.log('ðŸ“¦ Packaging for Firefox...');
              const firefoxZip = new AdmZip();
              firefoxZip.addLocalFolder(distDir);
              
              if (await fs.pathExists(firefoxManifest)) {
                firefoxZip.addFile('manifest.json', await fs.readFile(firefoxManifest));
              } else {
                // Fallback to MV2 manifest for Firefox
                const firefoxManifestContent = {
                  manifest_version: 2,
                  name: "Email Suite - Email Tracker for Gmail",
                  version: "1.0.0",
                  browser_specific_settings: {
                    gecko: {
                      id: "contact@emailsuite.yourdomain.com",
                      strict_min_version: "109.0"
                    }
                  },
                  description: "Track email opens, clicks, and boost productivity",
                  permissions: [
                    "storage",
                    "activeTab",
                    "https://mail.google.com/*",
                    "https://*.emailsuite.com/*"
                  ],
                  background: { scripts: ["dist/background.js"] },
                  content_scripts: [{
                    matches: ["https://mail.google.com/*"],
                    js: ["dist/content-scripts/gmail-injector.js"],
                    css: ["dist/styles/inject.css"]
                  }],
                  browser_action: {
                    default_popup: "dist/popup/index.html",
                    default_title: "Email Suite"
                  },
                  web_accessible_resources: ["dist/tracking-pixel.png"]
                };
                firefoxZip.addFile('manifest.json', Buffer.from(JSON.stringify(firefoxManifestContent, null, 2)));
              }
              firefoxZip.writeZip(path.join(__dirname, '../firefox-extension.zip'));
              console.log('âœ… Created firefox-extension.zip');

            } catch (error) {
              console.error('âŒ Failed to package extension:', error);
              process.exit(1);
            }
          }

          packageExtension();
          EOF
          
          # Run the packaging script
          node scripts/package-extension.js
      
      - name: Upload Chrome Extension
        if: matrix.component == 'chrome-extension'
        uses: actions/upload-artifact@v4
        with:
          name: chrome-extension
          path: ./frontend/chrome-extension/chrome-extension.zip
          
      - name: Upload Firefox Extension
        if: matrix.component == 'chrome-extension'
        uses: actions/upload-artifact@v4
        with:
          name: firefox-extension
          path: ./frontend/chrome-extension/firefox-extension.zip
      
      - name: Upload Web Dashboard
        if: matrix.component == 'web-dashboard'
        uses: actions/upload-artifact@v4
        with:
          name: web-dashboard
          path: ./frontend/web-dashboard/dist

          # 5. Sign & Submit Firefox Extension
  
  firefox-sign:
    needs: [frontends]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4

      - name: Download Firefox Extension
        uses: actions/download-artifact@v4
        with:
          name: firefox-extension
          path: ./release-dist/firefox

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install web-ext
        run: npm install -g web-ext

      - name: Sign Firefox Extension
        run: |
          web-ext sign \
            --source-dir ./release-dist/firefox \
            --api-key ${{ secrets.FIREFOX_API_KEY }} \
            --api-secret ${{ secrets.FIREFOX_API_SECRET }} \
            --channel listed

  # 2. Backend Test & Dockerize
  backend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: emailsuite_test
        ports: [5432:5432]
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
      redis:
        image: redis:7
        ports: [6379:6379]
        options: --health-cmd "redis-cli ping" --health-interval 10s --health-timeout 5s --health-retries 5
    defaults:
      run:
        working-directory: ./backend
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './Backend/package-lock.json'
      
      - name: Backend CI
        run: |
          npm ci
          npx prisma generate
          npm test
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/emailsuite_test
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-secret
      
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build & Push Image
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}/backend:latest
            ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}/backend:${{ github.sha }}

  # 3. Deployment (Render)
  deploy:
    needs: [frontends, backend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Trigger Render Deploy
        uses: johnbeynon/render-deploy-action@v0.0.8
        with:
          service-id: ${{ secrets.RENDER_SERVICE_ID }}
          api-key: ${{ secrets.RENDER_API_KEY }}
      
      - name: Wait for Deployment & Migrate
        run: |
          echo "Waiting for Render to start deployment..."
          sleep 30
          curl -X POST ${{ secrets.RENDER_MIGRATION_HOOK }} || echo "Migration hook failed but continuing"

      - name: Health Check
        run: |
          npm install -g wait-on
          wait-on ${{ secrets.API_URL }}/health --timeout 120000 || echo "Health check timed out but continuing"

  # 4. Release
  release:
    needs: [deploy]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Chrome Extension
        uses: actions/download-artifact@v4
        with:
          name: chrome-extension
          path: ./release-dist/chrome
      
      - name: Download Firefox Extension
        uses: actions/download-artifact@v4
        with:
          name: firefox-extension
          path: ./release-dist/firefox
      
      - name: Prepare Release Assets
        run: |
          # Rename files with version
          mv ./release-dist/chrome/chrome-extension.zip ./chrome-extension-${{ github.ref_name }}.zip
          mv ./release-dist/firefox/firefox-extension.zip ./firefox-extension-${{ github.ref_name }}.zip
          
          # Create source code archive
          git archive --format=zip --output=source-code-${{ github.ref_name }}.zip HEAD
          
          # List files
          ls -la *.zip
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            chrome-extension-${{ github.ref_name }}.zip
            firefox-extension-${{ github.ref_name }}.zip
            source-code-${{ github.ref_name }}.zip
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

