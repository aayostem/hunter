name: EmailSuite Pipeline

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '22.x'
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # 1. Frontend Matrix Build
  frontends:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [chrome-extension, web-dashboard]
    defaults:
      run:
        working-directory: ./Frontend/${{ matrix.component }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './Frontend/${{ matrix.component }}/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Package Chrome Extension (Multi-browser)
        if: matrix.component == 'chrome-extension'
        run: |
          npm install --save-dev fs-extra adm-zip
          mkdir -p scripts
          cat > scripts/package-extension.js << 'EOF'
          import fs from 'fs-extra';
          import path from 'path';
          import { fileURLToPath } from 'url';
          import AdmZip from 'adm-zip';

          const __dirname = path.dirname(fileURLToPath(import.meta.url));

          async function packageExtension() {
            try {
              const distDir = path.join(__dirname, '../dist');
              const chromeManifest = path.join(__dirname, '../manifest.chrome.json');
              const firefoxManifest = path.join(__dirname, '../manifest.firefox.json');

              if (!await fs.pathExists(distDir)) {
                throw new Error('Dist directory not found. Run build first!');
              }

              console.log('ðŸ“¦ Packaging for Chrome...');
              const chromeZip = new AdmZip();
              chromeZip.addLocalFolder(distDir);
              if (await fs.pathExists(chromeManifest)) {
                chromeZip.addFile('manifest.json', await fs.readFile(chromeManifest));
              }
              chromeZip.writeZip(path.join(__dirname, '../chrome-extension.zip'));
              console.log('âœ… Created chrome-extension.zip');

              console.log('ðŸ“¦ Packaging for Firefox...');
              const firefoxZip = new AdmZip();
              firefoxZip.addLocalFolder(distDir);
              if (await fs.pathExists(firefoxManifest)) {
                firefoxZip.addFile('manifest.json', await fs.readFile(firefoxManifest));
              }
              firefoxZip.writeZip(path.join(__dirname, '../firefox-extension.zip'));
              console.log('âœ… Created firefox-extension.zip');

            } catch (error) {
              console.error('âŒ Failed to package extension:', error);
              process.exit(1);
            }
          }

          packageExtension();
          EOF
          node scripts/package-extension.js

      - name: Upload Chrome Extension
        if: matrix.component == 'chrome-extension'
        uses: actions/upload-artifact@v4
        with:
          name: chrome-extension
          path: ./Frontend/chrome-extension/chrome-extension.zip

      - name: Upload Firefox Extension
        if: matrix.component == 'chrome-extension'
        uses: actions/upload-artifact@v4
        with:
          name: firefox-extension
          path: ./Frontend/chrome-extension/firefox-extension.zip

      - name: Upload Web Dashboard
        if: matrix.component == 'web-dashboard'
        uses: actions/upload-artifact@v4
        with:
          name: web-dashboard
          path: ./Frontend/web-dashboard/dist

  # 2. Sign & Submit Firefox Extension (tags only)
  firefox-sign:
    needs: [frontends]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4

      - name: Download Firefox Extension
        uses: actions/download-artifact@v4
        with:
          name: firefox-extension
          path: ./release-dist/firefox

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install web-ext
        run: npm install -g web-ext

      - name: Sign Firefox Extension
        run: |
          web-ext sign \
            --source-dir ./release-dist/firefox \
            --api-key ${{ secrets.FIREFOX_API_KEY }} \
            --api-secret ${{ secrets.FIREFOX_API_SECRET }} \
            --channel listed

  # 3. Backend Test & Dockerize
  backend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: emailsuite_test
        ports: [5432:5432]
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
      redis:
        image: redis:7
        ports: [6379:6379]
        options: --health-cmd "redis-cli ping" --health-interval 10s --health-timeout 5s --health-retries 5
    defaults:
      run:
        working-directory: ./Backend
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './Backend/package-lock.json'

      - name: Backend CI
        run: |
          npm ci
          npx prisma generate
          npx prisma migrate deploy
          npm test
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/emailsuite_test
          DIRECT_URL: postgresql://test:test@localhost:5432/emailsuite_test
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-secret
        
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push Image
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: ./Backend
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}/backend:latest
            ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}/backend:${{ github.sha }}

  # 4. Deploy Backend to Render (main branch only)
  deploy-backend:
    needs: [backend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - name: Trigger Render Deploy
        uses: johnbeynon/render-deploy-action@v0.0.8
        with:
          service-id: ${{ secrets.RENDER_SERVICE_ID }}
          api-key: ${{ secrets.RENDER_API_KEY }}

      - name: Health Check
        run: |
          npm install -g wait-on
          wait-on ${{ secrets.API_URL }}/health --timeout 120000 || echo "Health check timed out"

  # 5. Deploy Web Dashboard to Vercel (main branch only)
  deploy-web-dashboard:
    needs: [frontends]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Deploy to Vercel
        run: |
          cd Frontend/web-dashboard
          vercel deploy --prod --yes --token=${{ secrets.VERCEL_TOKEN }} \
            --build-env VITE_API_URL=${{ secrets.VITE_API_URL }} \
            --build-env VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }} \
            --build-env VITE_SUPABASE_ANON_KEY=${{ secrets.VITE_SUPABASE_ANON_KEY }}

  # 6. Release - tags only
  release:
    needs: [frontends, backend, firefox-sign]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4

      - name: Download Chrome Extension
        uses: actions/download-artifact@v4
        with:
          name: chrome-extension
          path: ./release-dist/chrome

      - name: Download Firefox Extension
        uses: actions/download-artifact@v4
        with:
          name: firefox-extension
          path: ./release-dist/firefox

      - name: Prepare Release Assets
        run: |
          mv ./release-dist/chrome/chrome-extension.zip ./chrome-extension-${{ github.ref_name }}.zip
          mv ./release-dist/firefox/firefox-extension.zip ./firefox-extension-${{ github.ref_name }}.zip
          git archive --format=zip --output=source-code-${{ github.ref_name }}.zip HEAD
          ls -la *.zip

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            chrome-extension-${{ github.ref_name }}.zip
            firefox-extension-${{ github.ref_name }}.zip
            source-code-${{ github.ref_name }}.zip
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}